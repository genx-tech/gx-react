{"version":3,"sources":["HttpClient.js"],"names":["AllowedMethods","get","post","put","del","delete","upload","download","resToPath","parts","Array","isArray","map","res","encodeURIComponent","join","setUploadBody","req","body","options","formData","entries","forEach","k","v","field","attach","fileField","HttpClient","constructor","endpoint","resource","query","_send","data","file","Runtime","jsRuntime","uri","name","Error","fileOthers","Platform","OS","replace","type","mime","lookup","method","path","setRequestBody","toLowerCase","httpMethod","url","startsWith","urlUtil","_createRequest","onSending","extraHeaders","headers","set","withCredentials","send","onProgress","on","result","text","onSent","error","response","onReponseError","onOtherError","request"],"mappings":"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","sourcesContent":["import request from 'superagent';\nimport { Platform } from 'react-native';\nimport { url as urlUtil } from '@genx/july';\nimport _each from 'lodash/each';\nimport * as mime from 'react-native-mime-types';\n\nimport Runtime from '../Runtime';\n\nconst AllowedMethods = {\n    get: 'get',\n    post: 'post',\n    put: 'put',\n    del: 'del',\n    delete: 'del',\n    upload: 'post',\n    download: 'get',\n};\n\nfunction resToPath(parts) {\n    return parts\n        ? Array.isArray(parts)\n            ? parts.map((res) => encodeURIComponent(res)).join('/')\n            : parts\n        : '';\n}\n\nfunction setUploadBody(req, body, options) {\n    if (options && options.formData) {\n        options.formData.entries.forEach(([k, v]) => {\n            req.field(k, v);\n        });\n    }\n\n    req.attach(options && options.fileField ? options.fileField : 'file', body);\n}\n\n/**\n * Http client.\n * @class\n */\nexport default class HttpClient {\n    /**\n     * HttpClient constructor\n     * @param {*} endpoint - Default endpoint\n     */\n    constructor(endpoint) {\n        endpoint != null || (endpoint = '');\n        this.endpoint = endpoint;\n    }\n\n    /**\n     * Http get request.\n     * @param {string|Array} resource\n     * @param {Object} query\n     * @param {Object} options\n     * @property {string} [options.endpoint] - Override the default base endpoint\n     * @property {Function} [options.onProgress] - Report progress when waiting for response\n     */\n    async get(resource, query, options) {\n        return this._send('get', resToPath(resource), query, null, options);\n    }\n\n    /**\n     * Http post request.\n     * @param {string|Array} resource\n     * @param {Object} data\n     * @param {Object} query\n     * @param {Object} options\n     * @property {string} [options.endpoint] - Override the default base endpoint\n     * @property {Function} [options.onProgress] - Report progress when waiting for response\n     */\n    async post(resource, data, query, options) {\n        return this._send('post', resToPath(resource), query, data, options);\n    }\n\n    /**\n     * Http put request.\n     * @param {string|Array} resource\n     * @param {Object} data\n     * @param {Object} query\n     * @param {Object} options\n     * @property {string} [options.endpoint] - Override the default base endpoint\n     * @property {Function} [options.onProgress] - Report progress when waiting for response\n     */\n    async put(resource, data, query, options) {\n        return this._send('put', resToPath(resource), query, data, options);\n    }\n\n    /**\n     * Http del request.\n     * @param {string|Array} resource\n     * @param {Object} query\n     * @param {Object} options\n     * @property {string} [options.endpoint] - Override the default base endpoint\n     * @property {Function} [options.onProgress] - Report progress when waiting for response\n     */\n    async del(resource, query, options) {\n        return this._send('del', resToPath(resource), query, null, options);\n    }\n\n    /**\n     * Http upload request.\n     * @param {string|Array} resource\n     * @param {string} file\n     * @param {Object} query\n     * @param {Object} options\n     * @property {string} [options.endpoint] - Override the default base endpoint\n     * @property {Function} [options.onProgress] - Report progress when waiting for response\n     * @property {Object} [options.formData] - Form data passed while uploading\n     * @property {string} [options.fileField=\"file\"] - File field name, default as \"file\"\n     */\n    async upload(resource, file, query, options) {\n        if (Runtime.jsRuntime === 'native') {\n            if (typeof file !== 'object' || !file.uri || !file.name) {\n                throw new Error(\n                    'File param should be an object with { uri, name } for uploading from native env.'\n                );\n            }\n\n            let { uri, ...fileOthers } = file;\n\n            if (Platform.OS === 'ios') {\n                uri = uri.replace('file://', '');\n            }\n\n            fileOthers.uri = uri;\n            if (!fileOthers.type) {\n                fileOthers.type = mime.lookup(fileOthers.name);\n            }\n\n            file = fileOthers;\n        }\n\n        return this._send(\n            'upload',\n            resToPath(resource),\n            query,\n            file,\n            options,\n            Runtime.jsRuntime === 'node' ? setUploadBody : null\n        );\n    }\n\n    /**\n     * Http download request.\n     * @param {string|Array} resource\n     * @param {Object} query\n     * @param {Object} options\n     * @property {string} [options.endpoint] - Override the default base endpoint\n     * @property {Function} [options.onProgress] - Report progress when waiting for response\n     */\n    async download(resource, query, options) {\n        return this._send(\n            'download',\n            resToPath(resource),\n            query,\n            null,\n            options\n        );\n    }\n\n    async _send(method, path, query, body, options, setRequestBody) {\n        method = method.toLowerCase();\n        const httpMethod = options?.httpMethod || AllowedMethods[method];\n        if (!httpMethod) {\n            throw new Error('Invalid method: ' + method);\n        }\n\n        const url =\n            path.startsWith('http:') ||\n            path.startsWith('https:') ||\n            !this.endpoint\n                ? path // absolute url\n                : urlUtil.join(\n                      options && options.endpoint\n                          ? options.endpoint\n                          : this.endpoint,\n                      path\n                  );\n\n        const req = this._createRequest(httpMethod, url);\n\n        if (this.onSending) {\n            this.onSending(req, httpMethod, url);\n        }\n\n        const extraHeaders = options?.headers;\n        if (extraHeaders) {\n            _each(extraHeaders, (v, k) => {\n                req.set(k, v);\n            });\n        }\n\n        if (options?.withCredentials) {\n            req.withCredentials();\n        }\n\n        if (query) {\n            req.query(query);\n        }\n\n        if (setRequestBody) {\n            setRequestBody(req, body, options);\n        } else {\n            req.send(body);\n        }\n\n        if (options && options.onProgress) {\n            req.on('progress', options.onProgress);\n        }\n\n        try {\n            const res = await req;\n            const result = res.body || res.text;\n\n            if (this.onSent) {\n                await this.onSent(url, result);\n            }\n\n            return result;\n        } catch (error) {\n            if (error.response && error.response.body) {\n                if (this.onReponseError) {\n                    return this.onReponseError(error.response.body);\n                }\n\n                throw error;\n            }\n\n            if (this.onOtherError) {\n                return this.onOtherError(error);\n            }\n\n            throw error;\n        }\n    }\n\n    _createRequest(httpMethod, url) {\n        return request[httpMethod](url);\n    }\n}\n"]}